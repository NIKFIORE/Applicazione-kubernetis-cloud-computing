# ========================================
# MODALITÀ IMPERATIVA
# ========================================

# 1. Navigazione nella directory del progetto
cd Applicazione-kubernetis-cloud-computing

# 2. Build immagine Docker
docker build -t python-app:latest app/

# 3. Caricamento immagine in Minikube
minikube image load python-app:latest

# 4. Creazione deployment MongoDB
kubectl create deployment mongodb --image=mongo:7.0

# 5. Esposizione servizio MongoDB
kubectl expose deployment mongodb \
  --port=27017 \
  --name=mongodb

# 6. Configurazione variabili ambiente MongoDB
kubectl set env deployment/mongodb \
  MONGO_INITDB_ROOT_USERNAME=admin \
  MONGO_INITDB_ROOT_PASSWORD=adminpassword

# 7. Attesa avvio MongoDB (30 secondi)
sleep 30

# 8. Inizializzazione database con dati di test
kubectl exec -it deployment/mongodb -- \
  mongosh -u admin -p adminpassword --authenticationDatabase admin \
  --eval "use dbDevOps; db.studenti.insertOne({matricola: '12345', nome: 'Luigi', cognome: 'Verdi', corso: 'Informatica'})"

# 9. Creazione deployment applicazione Python
kubectl create deployment python-app --image=python-app:latest

# 10. Configurazione variabili ambiente applicazione Python
kubectl set env deployment/python-app \
  MONGO_URI=mongodb://admin:adminpassword@mongodb:27017/dbDevOps?authSource=admin \
  DB_NAME=dbDevOps \
  COLLECTION_NAME=studenti

# 11. Configurazione policy di pull dell'immagine
kubectl patch deployment python-app -p \
'{"spec":{"template":{"spec":{"containers":[{"name":"python-app","imagePullPolicy":"IfNotPresent"}]}}}}'

# 12. Attesa avvio applicazione (20 secondi)
sleep 20

# 13. Verifica pods
kubectl get pods

# 14. Verifica logs applicazione
kubectl logs deployment/python-app

# 15. Pulizia risorse modalità imperativa
kubectl delete deployment python-app mongodb
kubectl delete service mongodb